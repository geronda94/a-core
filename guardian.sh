
#!/bin/bash

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
ID=777             # ID —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (—á—Ç–æ–±—ã –æ–Ω–æ –æ–±–Ω–æ–≤–ª—è–ª–æ—Å—å, –∞ –Ω–µ —Å–æ–∑–¥–∞–≤–∞–ª–æ—Å—å –Ω–æ–≤–æ–µ)
LAST_MSG=""        # –ö—ç—à —Å–æ–æ–±—â–µ–Ω–∏—è

# 1. –ó–ê–©–ò–¢–ê –û–¢ –ó–ê–°–´–ü–ê–ù–ò–Ø (Android –Ω–µ —É–±—å–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å)
termux-wake-lock

echo "=== A-CORE GUARDIAN: BACKGROUND + NOTIFY ==="

# –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ —à—Ç–æ—Ä–∫—É (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –∏–∑–º–µ–Ω–∏–ª—Å—è)
notify() {
    MSG="$1"
    # –ü–∏—à–µ–º –≤ –∫–æ–Ω—Å–æ–ª—å/–ª–æ–≥
    echo "$(date '+%H:%M:%S') $MSG"
    
    # –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–æ–≤–æ–µ - –æ–±–Ω–æ–≤–ª—è–µ–º —à—Ç–æ—Ä–∫—É
    if [ "$MSG" != "$LAST_MSG" ]; then
        termux-notification --title "A-Core Guardian üõ°Ô∏è" --content "$MSG" --id $ID --priority default
        LAST_MSG="$MSG"
    fi
}

# –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ ADB –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö
restart_adb() {
    notify "‚ò†Ô∏è –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ ADB —Å–µ—Ä–≤–µ—Ä–∞..."
    adb disconnect > /dev/null 2>&1
    adb kill-server
    sleep 2
    adb start-server
    sleep 2
}

# –°—Ç–∞—Ä—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
notify "üöÄ –°–ª—É–∂–±–∞ –∑–∞–ø—É—â–µ–Ω–∞"

while true; do
    # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ñ–ò–í–û–ï —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
    # –ò—â–µ–º —Å—Ç—Ä–æ–∫—É, –≥–¥–µ –≤ –∫–æ–Ω—Ü–µ "device"
    CURRENT_DEV=$(adb devices | grep "device$")
    
    if [ ! -z "$CURRENT_DEV" ]; then
        # –í—ã—Ç–∞—Å–∫–∏–≤–∞–µ–º –ø–æ—Ä—Ç –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã –æ—Ç—á–µ—Ç–∞
        PORT_INFO=$(echo "$CURRENT_DEV" | awk '{print $1}')
        notify "‚úÖ –ê–∫—Ç–∏–≤–µ–Ω: $PORT_INFO"
        sleep 10
    else
        notify "‚ö†Ô∏è –°–≤—è–∑—å –ø–æ—Ç–µ—Ä—è–Ω–∞. –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ..."
        
        # 2. –°–∫–∞–Ω–∏—Ä—É–µ–º –ø–æ—Ä—Ç (–±–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–π)
        PORT=$(nmap 127.0.0.1 -p 30000-49999 | grep "open" | head -n 1 | awk -F'/' '{print $1}')

        if [ -z "$PORT" ]; then
            # –ï—Å–ª–∏ –ø–æ—Ä—Ç–æ–≤ –Ω–µ—Ç, –ø—Ä–æ—Å—Ç–æ –∂–¥–µ–º, –Ω–µ –º–µ–Ω—è—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ
            sleep 5
        else
            notify "üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ $PORT..."
            
            # 3. –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
            OUTPUT=$(adb connect 127.0.0.1:$PORT 2>&1)
            echo "   > $OUTPUT"

            # 4. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
            if [[ "$OUTPUT" == *"failed"* ]] || [[ "$OUTPUT" == *"refused"* ]]; then
                restart_adb
            else
                # –í—Ä–æ–¥–µ –ø–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ –ø–∞—É–∑—É
                sleep 2
                if adb devices | grep -q "offline"; then
                    notify "‚ùå –°—Ç–∞—Ç—É—Å OFFLINE. –°–±—Ä–æ—Å..."
                    restart_adb
                else
                    notify "‚úÖ –£—Å–ø–µ—Ö! –ü–æ—Ä—Ç: $PORT"
                fi
            fi
        fi
    fi
done
