#!/usr/bin/env bash

ID=777
termux-wake-lock

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
MAX_RETRIES=3          # –°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –ø—Ä–æ—Å—Ç–∏—Ç—å –æ—à–∏–±–∫—É –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º
CHECK_INTERVAL=5       # –ü–∞—É–∑–∞ –º–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ (—Å–µ–∫)
CACHED_PORT=""         # –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–±–æ—á–∏–π –ø–æ—Ä—Ç

cleanup() {
    termux-notification-remove $ID
    termux-wake-unlock
    echo "Guard –≤—ã–∫–ª—é—á–µ–Ω."
    exit
}

trap cleanup SIGINT SIGTERM

notify_status() {
    termux-notification \
        --title "A-Core Guard v2 üõ°Ô∏è" \
        --content "$1" \
        --id $ID \
        --priority default
}

echo "=== GUARDIAN V2: STABLE MODE ==="

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏: –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 0 –µ—Å–ª–∏ –µ—Å—Ç—å –ñ–ò–í–û–ô –¥–µ–≤–∞–π—Å
check_connection() {
    # –ò—â–µ–º –¥–µ–≤–∞–π—Å, –∫–æ—Ç–æ—Ä—ã–π –∏–º–µ–Ω–Ω–æ 'device' (–≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ)
    if adb devices | grep -q "[[:space:]]device$"; then
        return 0
    else
        return 1
    fi
}

# –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ –ø–æ—Ä—Ç–∞ —á–µ—Ä–µ–∑ Nmap
find_adb_port() {
    # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º —Å—Ç–∞—Ä—ã–π –ø–æ—Ä—Ç, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å, —á—Ç–æ–±—ã –Ω–µ –Ω–∞–≥—Ä—É–∂–∞—Ç—å CPU —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
    if [ ! -z "$CACHED_PORT" ]; then
        if nc -z localhost $CACHED_PORT 2>/dev/null; then
            echo "$CACHED_PORT"
            return
        fi
    fi

    # –ï—Å–ª–∏ —Å—Ç–∞—Ä—ã–π –ø–æ—Ä—Ç –º–µ—Ä—Ç–≤, –∏—â–µ–º –Ω–æ–≤—ã–π
    nmap localhost -p 30000-49999 \
        | awk '/open/ {print $1}' \
        | cut -d'/' -f1 \
        | head -n 1
}

# –ú—è–≥–∫–∞—è –æ—á–∏—Å—Ç–∫–∞: —É–¥–∞–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å offline –≤–∏—Å–∏—Ç —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ
# –í —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏ –º—ã –ø—Ä–æ—Å—Ç–æ –¥–µ–ª–∞–µ–º adb disconnect –¥–ª—è –≤—Å–µ—Ö, –ö–†–û–ú–ï –∂–∏–≤—ã—Ö,
# –Ω–æ —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ —Ä–µ–∞–ª—å–Ω–æ –ø–æ—Ç–µ—Ä—è–ª–∏ —Å–≤—è–∑—å –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ü–∏–∫–ª–µ.
force_reconnect() {
    echo "[!] –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π..."
    adb disconnect >/dev/null 2>&1
    
    # –ò–Ω–æ–≥–¥–∞ ADB —Å–µ—Ä–≤–µ—Ä –∑–∞–≤–∏—Å–∞–µ—Ç, –µ—Å–ª–∏ –µ–≥–æ —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ –¥–µ—Ä–≥–∞—Ç—å
    # adb kill-server # –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π, –µ—Å–ª–∏ —Å–æ–≤—Å–µ–º –≤—Å—ë –ø–ª–æ—Ö–æ, –Ω–æ —ç—Ç–æ —Å–±—Ä–æ—Å–∏—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
}

# --- MAIN LOOP ---

FAIL_COUNT=0

while true; do
    if check_connection; then
        # –í—Å—ë —Ö–æ—Ä–æ—à–æ
        if [ $FAIL_COUNT -gt 0 ]; then
            echo -n " (–°—Ç–∞–±–∏–ª—å–Ω–æ)"
            notify_status "‚úÖ –°–∏—Å—Ç–µ–º–∞ –≤ –Ω–æ—Ä–º–µ"
        else
            echo -n "."
        fi
        
        FAIL_COUNT=0
        CACHED_PORT=$(adb devices | grep "device$" | awk '{print $1}' | cut -d: -f2)
        sleep $CHECK_INTERVAL
        continue
    fi

    # –ï—Å–ª–∏ –º—ã –∑–¥–µ—Å—å, –∑–Ω–∞—á–∏—Ç –∂–∏–≤–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –Ω–µ—Ç.
    # –ù–æ –Ω–µ –ø–∞–Ω–∏–∫—É–µ–º —Å—Ä–∞–∑—É. –î–∞–µ–º —à–∞–Ω—Å (–∑–∞—â–∏—Ç–∞ –æ—Ç "–º–∏–≥–∞—é—â–µ–≥–æ" —Å—Ç–∞—Ç—É—Å–∞)
    FAIL_COUNT=$((FAIL_COUNT + 1))
    
    echo ""
    echo "[?!] –ü–æ—Ç–µ—Ä—è —Å–≤—è–∑–∏: –ø–æ–ø—ã—Ç–∫–∞ $FAIL_COUNT –∏–∑ $MAX_RETRIES"

    if [ $FAIL_COUNT -lt $MAX_RETRIES ]; then
        # –ü—Ä–æ—Å—Ç–æ –∂–¥–µ–º, –≤–æ–∑–º–æ–∂–Ω–æ –¥–µ–≤–∞–π—Å —Å–∞–º –ø–µ—Ä–µ–π–¥–µ—Ç –∏–∑ offline –≤ device
        sleep 3
        continue
    fi

    # –ï—Å–ª–∏ –æ—à–∏–±–æ–∫ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ - –Ω–∞—á–∏–Ω–∞–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
    notify_status "‚ö†Ô∏è –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–≤—è–∑–∏..."
    
    # 1. –†–≤–µ–º —Å—Ç–∞—Ä—ã–µ —Å–≤—è–∑–∏, —á—Ç–æ–±—ã –Ω–µ –ø–ª–æ–¥–∏—Ç—å –∑–æ–º–±–∏
    force_reconnect
    
    # 2. –ò—â–µ–º –ø–æ—Ä—Ç
    PORT=$(find_adb_port)
    
    if [ -z "$PORT" ]; then
        notify_status "üîç –ü–æ—Ä—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω (Wireless Debugging –≤—ã–∫–ª—é—á–µ–Ω?)"
        sleep 10
        continue
    fi

    # 3. –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è
    echo "[+] –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ $PORT..."
    adb connect localhost:$PORT >/dev/null 2>&1
    
    # –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é (Authorizing -> Device)
    sleep 5
    
    if check_connection; then
        notify_status "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ: $PORT"
        CACHED_PORT=$PORT
        FAIL_COUNT=0
    else
        notify_status "‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è"
        # –ï—Å–ª–∏ –Ω–µ –≤—ã—à–ª–æ, –≤ —Å–ª–µ–¥—É—é—â–µ–º —Ü–∏–∫–ª–µ —Å—á–µ—Ç—á–∏–∫ —É–∂–µ –ø—Ä–µ–≤—ã—à–µ–Ω, 
        # —Ç–∞–∫ —á—Ç–æ –æ–Ω —Å–Ω–æ–≤–∞ –ø–æ–ø—Ä–æ–±—É–µ—Ç –Ω–∞–π—Ç–∏ –ø–æ—Ä—Ç.
    fi
done